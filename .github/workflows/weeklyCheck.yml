name: BUILD

on:
  schedule:
   - 0 12 * * 0
  workflow_dispatch:  
   
jobs:

  build:
    runs-on: ubuntu-latest   
    steps:
       quality:    
    # The type of runner that the job will run on
        runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
        steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
          - uses: actions/checkout@v2  
            with:
            ref: master
           
          - name: Set up JDK 11
            uses: actions/setup-java@v1
            with:
             java-version: 11
          - name: Cache SonarCloud packages
            uses: actions/cache@v1
            with:
               path: ~/.sonar/cache
               key: ${{ runner.os }}-sonar
               restore-keys: ${{ runner.os }}-sonar
          - name: Cache Maven packages
            uses: actions/cache@v1
            with:
               path: ~/.m2
               key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
               restore-keys: ${{ runner.os }}-m2
          - name: Build and analyze
            env:
               GITHUB_TOKEN: ${{ secrets.MY_GITHUBKEY }}  # Needed to get PR information, if any
               SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
            run: mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.projectKey=MOderkerk_EmailValidationService -Dsonar.qualitygate.wait=true -DskipTests=true
          - name: Report error
            if: ${{ failure() }}
            uses: nashmaniac/create-issue-action@v1.1
            title: Weekly Sonar Cube analysis failed
            token: ${{secrets.MY_GITHUBKEY}}            
            labels: worflow-failed
            body:  Weekly Sonar Cube analysis failed

            
            
